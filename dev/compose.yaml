name: neoboard

services:
  web:
    build:
      context: ./nginx
    restart: unless-stopped
    depends_on:
      - synapse
      - mas
    ports:
      - '127.0.0.1:443:443'
      - '127.0.0.1:8448:8448'
    networks:
      default:
        aliases:
          - matrix.internal
          - mas.matrix.internal
          - synapse.matrix.internal

  synapse-db:
    image: postgres:16
    restart: unless-stopped
    environment:
      - POSTGRES_DB=synapse
      - POSTGRES_PASSWORD=s3cr3t
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    volumes:
      - 'synapse-db:/var/lib/postgresql/data'

  synapse:
    image: matrixdotorg/synapse:latest
    restart: unless-stopped
    depends_on:
      - synapse-db
    environment:
      # make Synapse easily work with every container runtime
      - UID=0
      - GID=0
    volumes:
      - synapse:/data
      - ./synapse/homeserver.yaml:/data/homeserver.yaml:ro
      - ./synapse/matrix.internal.log.config:/data/matrix.internal.log.config:ro
      - ./synapse/matrix.internal.signing.key:/data/matrix.internal.signing.key:ro

  mas-db:
    image: postgres:16
    restart: unless-stopped
    environment:
      - POSTGRES_DB=mas
      - POSTGRES_PASSWORD=s3cr3t
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    volumes:
      - 'mas-db:/var/lib/postgresql/data'

  mas:
    image: ghcr.io/element-hq/matrix-authentication-service:main
    restart: unless-stopped
    depends_on:
      - mas-db
    volumes:
      - ./mas/config.yaml:/config.yaml:ro

volumes:
  synapse:
  synapse-db:
  mas-db:
